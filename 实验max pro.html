<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>实验</title>

    <script src='jspsych-6.1.0/jspsych.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-survey-text.js'></script>
    <script src='jspsych-6.1.0/plugins/jspsych-html-button-response.js'></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
    <style>
        .zfx {
            margin: 0 20px;
        }

        #jspsych-html-keyboard-response-stimulus {
            width: 600px;
            /* 中间盒子宽度 */
            min-height: 500px;
            /*中间盒子最小高度*/
            display: flex;
            /*设置弹性盒布局*/
            flex-direction: column;
            /*设置弹性盒为纵向的布局*/
            align-items: center;
            /*垂直居中*/
            justify-content: space-around;
            /*弹性盒对象的 <div> 元素中的各项周围留有空白,并且是均分的,横向的*/
            position: relative;
            /*绝对定位 父元素相对定位*/
        }

        #aaa {
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 30px !important;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -15px;
            margin-top: -15px;

        }





         .flex_body {
            display: flex;
            justify-content: center;
        }

    </style>
</head>

<body style="text-align:center;">

    <p id="demo">Hello</p>
</body>
<script>
    var timeline = [];



    var test_stimuli = [{
            stimulus: "img/2.png",
            item: '<span style="font-size:40px;">坏人</span>',
            data: {
                test_part: 'test',
                correct_response: 'm'
            }
        },
        {
            stimulus: "img/2.png",
            item: '<span style="font-size:40px;">好人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        },
        {
            stimulus: "img/2.png",
            item: '<span style="font-size:40px;">常人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        },
        {
            stimulus: "img/3.png",
            item: '<span style="font-size:40px;">坏人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        },
        {
            stimulus: "img/3.png",
            item: '<span style="font-size:40px;">好人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        },
        {
            stimulus: "img/3.png",
            item: '<span style="font-size:40px;">常人</span>',
            data: {
                test_part: 'test',
                correct_response: 'm'
            }
        },
        {
            stimulus: "img/1.png",
            item: '<span style="font-size:40px;">坏人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        },
        {
            stimulus: "img/1.png",
            item: '<span style="font-size:40px;">好人</span>',
            data: {
                test_part: 'test',
                correct_response: 'm'
            }
        },
        {
            stimulus: "img/1.png",
            item: '<span style="font-size:40px;">常人</span>',
            data: {
                test_part: 'test',
                correct_response: 'n'
            }
        }
    ];

    /* define welcome message trial */
    var enterFullscreenMode = {
        type: "fullscreen",
        fullscreen_mode: true,
        message: "<p>实验需要全屏模式</p>",
        button_label: "点击这里进入全屏"
    };
    timeline.push(enterFullscreenMode);

    document
        .querySelector('p')
        .addEventListener('click', function (e) {
            e.target.remove();
        });

    const screenWidth = window.screen.width;
    const screenHeight = window.screen.height;
    console.log(screenHeight);

    //Size = (visual angle * distance)/57.3 根据视角先计算出以厘米为单位的刺激大小
    const stimuli_size = 3; //the stimulus is 2cm
    const item_size = 1; //the item is 1cm
    const fixation_size = 1; // the fixation is 1cm
    console.log(screenWidth);

    var fixation_px = [];


    var survey_trial = {
        type: 'survey-text',
        questions: [{
            prompt: "Your screen width is (in cm):",
            name: 'Width_cm'
        }, ],
        on_finish: function (data) {
            var answer = JSON.parse(data.responses);
            var Width_cm = answer.Width_cm;

            var size_px = (screenWidth / Width_cm) * item_size;
            img_px = (screenWidth / Width_cm) * stimuli_size;
            fixation_px = (screenWidth / Width_cm) * fixation_size;

            for (let i = 0; i < test_stimuli.length; i++) {
                test_stimuli[i].item = '<span class="people" style="font-size:' + size_px + 'px">' +
                    test_stimuli[i].item + '</span>';
                test_stimuli[i].stimulus = '<img  class="img_common" src="' + test_stimuli[i].stimulus +
                    '" width=' + img_px + 'px></img>';


            };

        }
    };
    timeline.push(survey_trial);
    var welcome = {
        type: "html-keyboard-response",
        stimulus: 
        "<p style='font: bold 42px 华文楷体; color: #B22222'>\
       欢迎参与我们的实验</p>\
       <p style='font：30px S华文楷体; color: black'><br/>\
       <按任意键继续><br/><b>实验过程中请勿退出全屏</b>\
       <br/><br/></p>\
       <p style='font:24px 华文楷体; color: grey'>\
       胡传鹏研究小组<br/>2021年</p>",
        post_trial_gap: 100
    };
    timeline.push(welcome);
 
    var instr = {
  type: "instructions",
  pages: [
    "<p style='text-align: left'>\
    知情同意书：<br/>\
    您在本研究中所提供的数据和样本未来可能会被其他研究项目使用。未来的这些项目也许会与本研究的问题相关，也有可能无关。通过互联网和完全公开的数据库，我们将完全共享本次研究中的数据，包括脑影像数据。<br/>\
    共享的数据中不会出现您的姓名，而仅以代号显示，所以他人不会获知您的姓名，也无法将数据与您进行对应。此外，我们也将对其他敏感信息进行保密，避免了解您的人通过某些信息猜测到哪些是您的数据。<br/><br/>\
    如果您改变主意并想将此同意书撤回（您可以通过拨打『某号码』致电『本研究的主要负责人PI XXXX』来执行此操作），我们将不会录入关于您的任何额外数据。如果您在数据被录入数据库之前申请撤回，您的数据将能够被及时删除。<strong>请注意，所有已经共享给其他研究者或公众的数据和研究结果将不能够再被销毁，退出或撤回。</strong><br/>\
    同意参与本研究，意味着您将给那些可能有助于人类的研究提供一份免费而慷慨的礼物。极有可能，使用您所共享数据的研究会开发出新的研究人脑的技术、新的诊断量表、新药物或其他产出。但是如果出现这些情况，您本人不会得到这些产品所带来的任何利润，也不会获得这些产品的任何所有权。<br/>\
    <strong>同意请按“继续”</strong></p >"
    ],
  show_clickable_nav: true,
  allow_backward: false,
  button_label_previous: "返回",
  button_label_next: "继续",
};
timeline.push(instr);
var instr1 = {
  type: "instructions",
  pages: [
    "<p style='text-align: left'>\
    知情同意书：<br/>\
    根据我们充分了解到的情况，<strong>我们向公众共享的数据中将不会包含能够直接识别出您身份的信息。**数据中没有您的名字、只有编码的数字，因此他人不会知道您的名字或者知道哪个数据是您。此外，数据中不会包括我们认为可能会让了解您的人猜测到哪个数据属于您的信息，比如您的面部特征或参与研究的日期等。如果我们就本研究撰写报告、文章，或者将本次研究的数据分享给他人，我们也将确保您不会被识别出来。</strong><br/>\
    根据我们充分了解到的情况，<strong>我们向公众共享的数据中将不会包含能够直接识别出您身份的信息。**数据中没有您的名字、只有编码的数字，因此他人不会知道您的名字或者知道哪个数据是您。此外，数据中不会包括我们认为可能会让了解您的人猜测到哪个数据属于您的信息，比如您的面部特征或参与研究的日期等。如果我们就本研究撰写报告、文章，或者将本次研究的数据分享给他人，我们也将确保您不会被识别出来。</strong><br/>\
    您数据的隐私部分（包括姓名，联系方式等）将至少被安全保存<X>年。这样的话，如果研究人员在您的脑部扫描数据中发现某些具有诊断价值的信息，我们能够与您取得联系。在该期限后，我们将会销毁这些信息以保护您的隐私。<br/>\
    <strong>是否让我们使用及分享您的数据将完全由您自愿决定。但是，参加本研究的前提是您愿意使用这种方式来分享您的数据。如果您不愿意，您将无法参加这项研究。</strong><br/>\
    如果您在下方签名，代表您同意向未来的研究共享您的数据，同意与来自世界各地研究机构的研究者共享您的数据。这些未来研究的细节、结果和应用均是未知的。<br/>\
    <strong>同意请按“继续”</strong></p >"
    ],
  show_clickable_nav: true,
  allow_backward: false,
  button_label_previous: "返回",
  button_label_next: "继续",
};
timeline.push(instr1);


// 运行实验（总控制）
jsPsych.init({
  timeline: timeline,
  on_finish: function() {
    jsPsych.data.get().localSave("csv", "data.csv");
  }
});

    var experinumber ={
        type:"survey-html-form",
        data:{
            varname:'experinumber',
        },
        
        preamble:"你的实验编号是",
        html:"<p><input name='Q0' type='number' value='0001' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
        
    };
    timeline.push(experinumber);
    var subjectnumber ={
        type:"survey-html-form",
        data:{
            varname:'subjectnumber',
        },
       
        preamble:"你的编号是",
        html:"<p><input name='Q0' type='number' value='0001' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
        
    };
    timeline.push(subjectnumber);
    var number_of_experiment ={
        type:"survey-html-form",
        data:{
            varname:'number_of_experiment',
        },
       
        preamble:"你的实验次数是",
        html:"<p><input name='Q0' type='number' value='1' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
        
    };
    timeline.push(number_of_experiment);

    var sex = {
        type: 'html-button-response',
        data: {
            varname: 'sex'
        },
        stimulus: '你的性别',
        choices: ['男', '女', '其他'],
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    timeline.push(sex);
    var birth = {
        type: 'survey-html-form',
        data: {
            varname: 'birth'
        },
        preamble: '你的出生年',
        html: `
    <p><input name="Q0" type="number" placeholder="1900~2020" min=1900 max=2020
    oninput="if(value.length>4) value=value.slice(0,4)" required /></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    timeline.push(birth);

    var education = {
        type: 'survey-html-form',
        data: {
            varname: 'education'
        },
        preamble: '教育经历',
        html: `
       <p><select name="Q0" size=10>
       <option>小学以下</option>
       <option>小学</option>
       <option>初中</option>
       <option>高中</option>
       <option>大学</option>
       <option>大学以上</option>
       </select></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }
    };
    timeline.push(education);
    

    

    /* define instructions trial */
    var instructions1 = {
        type: "html-keyboard-response",
        stimulus: "<div><p>在这个实验中,图片和文字会一起出现在屏幕上。" +
            "</p><p>如果<strong>三角形</strong>对应的是 <strong>好人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>圆形</strong>对应的是 <strong>坏人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>正方形</strong>对应的是 <strong>常人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>上述图形和文字</strong><strong>不匹配</strong>, " +
            "在键盘上按下 <strong>N</strong> </p>" +
            "<div style='width: 1000px;' class='flex_body'>" +
            "<div class='item_flex' style=''><img src='img/2.png'></img>" +
            "<p class='small'><strong>坏人</strong></p></div>" +
            "<div class='item_flex zfx' style=''class='zfx'><img src='img/3.png'></img>" +
            "<p class='small'><strong>常人</strong></p></div>" +
            "<div class='item_flex' class=''><img src='img/1.png'></img>" +
            "<p class='small'><strong>好人</strong></p></div>" +
            "</div>" +
            "<p>按任意键开始实验</p><div>",
        post_trial_gap: 2000
    };
    timeline.push(instructions1);

    /* test trials */
    var fixation = {
        type: 'html-keyboard-response',

        stimulus: function () {
            return "<div class='add_' style='font-size:" + fixation_px + "px' id='aaa'>+</div>"
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: function () {
            return jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750,
                2000
            ], 1)[0];
        },
        data: {
            test_part: 'fixation'
        }

    }
    

    var test = {
        type: "html-keyboard-response",
        choices: ['m', 'n'],
        stimulus_duration: 100,
        trial_duration: 2100,
        stimulus: function () {


            return jsPsych.timelineVariable('stimulus', true) +
                "<p style='font-size:" + fixation_px + "px' class='add_' id='aaa'>+</p>" +
                "<p>" + jsPsych.timelineVariable('item', true) + "</p>"
        },
        data: jsPsych.timelineVariable('data'),
        //post_trial_gap: 5000,

        on_finish: function (data) {
            var accuracy = false;
            if (data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press)) {
                accuracy = true;
            } else if (data.key_press == null) {
                accuracy = 2;
            }

            data.accuracy = accuracy;
        }
    };

    //timeline.push(test);

    var feedback_trial = {
        data: {
            screen_id: "feedback"
        },
        type: "html-keyboard-response",
        stimulus: function () {
            var last_trial_accuracy = jsPsych.data.get().last(1).values()[0].accuracy;
            if (last_trial_accuracy == 1) {
                return "<span class='add_'>correct! </span>"
            } else if (last_trial_accuracy == 2) {
                return "<span class='add_'>Too slow!</span>"
            } else {
                return "<span class='add_'>incorrect!</span>"
            }
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: 300
    };


    var test_procedure = {
        timeline: [fixation, test, feedback_trial],
        timeline_variables: test_stimuli,
        repetitions: 1,
        randomize_order: true
    }
    timeline.push(test_procedure);

    /* define debrief */

    var debrief_block = {
        type: "html-keyboard-response",
        stimulus: function () {

            var trials = jsPsych.data.get().filter({
                test_part: 'test'
            });
            var correct_trials = trials.filter({
                accuracy: true
            });
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            var rt = Math.round(correct_trials.select('rt').mean());

            return "<p>You responded correctly on " + accuracy + "% of the trials.</p>" +
                "<p>Your average response time was " + rt + "ms.</p>" +
                "<p>Press any key to complete the experiment. Thank you!</p>";

        }
    };
    timeline.push(debrief_block);
    
var rest = {
        type: "html-keyboard-response",
        stimulus: "<span style='color:black;font-size:38px'><strong>休息7秒钟吧</strong></span>" +
            "<p>进入提示语请准备好下一轮实验</p><div>",
        choices: jsPsych.NO_KEYS,
        stimulus_duration: 2000,
        trial_duration: 5000,
    };
    timeline.push(rest);
    
    var instructions2 = {
        type: "html-keyboard-response",
        stimulus: "<div><p>在这个实验中,图片和文字会一起出现在屏幕上。" +
            "</p><p>如果<strong>三角形</strong>对应的是 <strong>好人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>圆形</strong>对应的是 <strong>坏人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>正方形</strong>对应的是 <strong>常人</strong>, " +
            "在键盘上按下 <strong>M</strong> </p>" +
            "<p><p>如果<strong>上述图形和文字</strong><strong>不匹配</strong>, " +
            "在键盘上按下 <strong>N</strong> </p>" +
            "<div style='width: 1000px;' class='flex_body'>" +
            "<div class='item_flex' style=''><img src='img/2.png'></img>" +
            "<p class='small'><strong>坏人</strong></p></div>" +
            "<div class='item_flex zfx' style=''class='zfx'><img src='img/3.png'></img>" +
            "<p class='small'><strong>常人</strong></p></div>" +
            "<div class='item_flex' class=''><img src='img/1.png'></img>" +
            "<p class='small'><strong>好人</strong></p></div>" +
            "</div>" +
            "<p>按任意键开始实验</p><div>",
        post_trial_gap: 2000
    };
    timeline.push(instructions2);
    
//bolck
var i=0;
var while_chunk = {
	timeline: [test_procedure,debrief_block,rest,instructions2],

	loop_function: function(data){
    i=i+1;
    if(i<1){
     
      return true;
    }else{
      return false;
    }
		}
	}
 
  timeline.push(while_chunk);

    /* start the experiment */
    jsPsych.init({
        timeline: timeline,
        on_finish: function () {
            jsPsych.data.get().localSave('csv', 'data.csv');
        }
    });
</script>

</html>